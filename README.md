node-red-contrib-ocpp-centralsystem
========================


[Node-Red][4] nodes for communicating with the EVSE Charge Points via the [Open Charge Point Protocol][6] (hereafter OCPP). These node-red nodes
allow you to take on the role of a Central System.  

Based on the [OCPP 1.5][6] secification utilizing the Simple Object Access Protocol (hereafter SOAP).

#Install

Run the following command in the root directory of your Node-RED install

    npm install node-red-contrib-ocpp-centralsystem


#Requirements

The package currently requires [Node.js 6.5][1] or higher.

#Nodes

* ocpp-request
* ocpp-server
* copp-response

## ocpp-request
This node allows you to make requests to an EVSE charge point and return a message with the response from that request. It is
flexible in that you can either set up a default command and/or data to send when you configure the node, or you may pass in 
that information to override the defaults via a message payload.

For example, to set up a *Reset* command request, you can select the *Reset* command from the nodes configuraiton dropdown. The Reset command
also requires sending a parameter indicating the type of reset to be performed, either *hard* or *soft*. In the Command Params field of the configuration, you would provide a JSON formatted object similar to this:

```json
{
    "type": "soft"
}
```


Alternately, you can pass the node a payload which contains a command and/or data to override the defaults. To make a *Reset* request
by passing it a message, the message payload (*msg.payload*) would look as follows:


```json
{
    "commnad": "Reset",
    "data" : { "type" : "hard" }
}
```

If either the command or the data sections are missing from from the message, the defaults will be used. If you set up an *ocpp-request* node
with a default command of *Reset*, you could pass in just the following:


**for hard reset**
```json
{
    "data": { "type": "hard" }
}
```

**for soft reset**
```json
{
    "data": { "type": "soft"}
}
```

The output returned by the node has the following message format:

```json
{
    "ocpp": {
        "command": "<the command being responded to>",
        "chargeBoxIdentity": "<the name of the EVSE charge box responding>",
        "url": "<the URL of the responding charge box>",
        "data": "<the data that was sent with the command to make the request>"        
    },
    "payload": {
        "key": "value"
    }
}
```

The payload portion varies depending on the command and EVSE charge point vendor specifications.


## ocpp-server
The ocpp-server node will listen for incoming reqests coming from the EVSE charge points that are targeting its address.
When the ocpp-server node receives a message, it will output a message in the following format:

```json
{
    "ocpp": {
        "command": "<the command being requested>",
        "chargeBoxIdentity": "<the name of the charge box making the request>",
        "From": "<optional address of the incoming request>",
        "MessageID": "<optional incoming request message id generated by the charge box>"
    },
    "payload": {
        "command": "<the command being requested>",
        "data": "<arguments received with the incoming request command stored in key/value pairs>"
    }
}
```

The incoming messages require a response (sent through the *ocpp-response* node), and those responses should be sent within 
a resonable amount of time. The ocpp-server node will cancle any outstanding responses after a 2 minute time period. The EVSE side 
may timeout awaiting a response even sooner than that depending on their configuration.

## ocpp-response
To return a response to an incoming EVSE charge point request, you need to pass your message to the ocpp-response node. Since the message 
coming out of the ocpp-server node contains information about how to return the response, the message itself should be passed as is through
the node flow with the expection of the msg.payload section. The msg.payload should be modified to contain the response to the incoming request.

For example, to accept a *BootNotification* request, set the payload of the response as:

```json
{
    "status": "Accepted",
    "currentTime": new Date().toISOString(),
    "heartbeatInterval": 60
}
```

(The message being passed from the server contains a unique identifier contained in msg.msgID. This needs to be present in the response message in order for the message to be returned to the proper request)

#Author

[Jason D. Harper][5] 

[1]:https://nodejs.org/
[2]:https://na.chargepoint.com/UI/downloads/en/ChargePoint_Web_Services_API_Guide_Ver4.1_Rev4.pdf
[3]:https://webservices.chargepoint.com/cp_api_4.1.wsdl
[4]:http://nodered.org
[5]:https://github.com/jayharper
[6]:http://www.openchargealliance.org/protocols/ocpp/ocpp-15/
[7]:http://www.openchargealliance.org/uploads/files/protected/ocpp_specification_1.5_final.pdf

